// Document generated by render-adoc.go from odsComponentStageRolloutOpenShiftDeployment.adoc.tmpl; DO NOT EDIT.

Rolls out the current resources as defined in the component.

Without any configuration the stage tries to guess what a user expects.
If the component contains a directory name `chart`, a Helm deployment is assumed.
If the component contains a directory name `openshift`, a Tailor deployment is assumed.
If neither exists a Tailor deployment is assumed.

== Helm

Triggers a release or update of an release with Helm.

The stage will use the `helm` command to trigger the release.
The command will be executed in the directory referenced by `chartDir`.
If the directory does not exist, the stage will fail.

The images used in the deployment will not be tagged or otherwise modified.

[source,shell]
----
HELM_DIFF_IGNORE_UNKNOWN_FLAGS=true helm -n play-dev secrets diff upgrade \
  --install --atomic --force \
  -f values.yaml \
  --set registry=registry.example.com \
  --set componentId=example-helm-chart \
  --set imageNamespace=example-dev \
  --set imageTag=deadbeef69cafebabe \
  --no-color --three-way-merge --normalize-manifests \
  example-release . || true

# run the upgrade
helm -n play-dev secrets upgrade \
  --install --atomic --force \
  -f values.yaml \
  --set registry=registry.example.com \
  --set componentId=example-helm-chart \
  --set imageNamespace=play-dev \
  --set imageTag=deadbeef69cafebabe \
  example-release .
----

== Tailor

Triggers (and follows) a rollout of the `DeploymentConfig` related to the repository
being built.

It achieves this by tagging the image built in `odsComponentStageBuildOpenShiftImage` with `latest`.
This might already trigger a rollout based on an existing `ImageTrigger`.
If none is set, the stage will start a manual rollout.

If the directory referenced by `openshiftDir` exists, the templates in there will be applied using https://github.com/opendevstack/tailor[Tailor].
In this case, it is recommended to remove any image triggers to avoid duplicate rollouts
(one when configuration changes due to a config trigger and one when the image is tagged to `latest`).
In addition to the configuration options below, one can use e.g. a `Tailorfile` to adjust the behaviour of Tailor as needed.

== Options

[cols="1,2"]
|===
| Option | Description


| *branch* +
_String_
|Branch to run stage for.
 Example: `'master'`.
 Next to exact matches, it also supports prefixes (e.g. `feature/`) and all branches (`*`).


| *branches* +
_List<String>_
|Branches to run stage for.
 Example: `['master', 'develop']`.
 Next to exact matches, it also supports prefixes (e.g. `feature/`) and all branches (`*`).


| *chartDir* +
_String_
|Directory of Helm chart (defaults to `chart`).


| *deployTimeoutMinutes* +
_Integer_
|Adjust timeout of rollout (defaults to 5 minutes). Caution: This needs to
 be aligned with the deployment strategy timeout (timeoutSeconds) and the
 readiness probe timeouts (initialDelaySeconds + failureThreshold * periodSeconds).


| *deployTimeoutRetries* +
_Integer_
|Adjust retries to wait for the pod during a rollout (defaults to 5).


| *helmAdditionalFlags* +
_List<String>_
|List of additional flags to be passed verbatim to to `helm upgrade`
(empty by default). Only relevant if the directory referenced by
`chartDir` exists.


| *helmDefaultFlags* +
_List<String>_
|List of default flags to be passed verbatim to to `helm upgrade`
 (defaults to `['--install', '--atomic']`). Typically these should not be
 modified - if you want to pass more flags, use `helmAdditionalFlags`
 instead. Only relevant if the directory referenced by `chartDir` exists.


| *helmDiff* +
_boolean_
|Whether to show diff explaining changes to the release before running
 `helm upgrade` (`true` by default). Only relevant if the directory
 referenced by `chartDir` exists.


| *helmEnvBasedValuesFiles* +
_List<String>_
|List of paths to values files (empty by default). Only relevant if the
 directory referenced by `chartDir` exists.
 These must contain a suffix called '.env.yml' - which will be replaced
 during rollout and deployment, and then added to helmValueFiles

 Passing a string literal of 'values.env.yaml' will be expanded to their respective environments.

 For example: 'values.env.yaml' will become 'values.dev.yaml', 'values.test.yaml' or 'values.prod.yaml'.
 That means creating the usual files that are named after their respective environment are parsed as usual.


| *helmPrivateKeyCredentialsId* +
_String_
|Credentials name of the private key used by helm-secrets (defaults to
 `${context.cdProject}-helm-private-key`). The fingerprint must match the
 one specified in `.sops.yaml`. Only relevant if the directory referenced
 by `chartDir` exists.


| *helmReleaseName* +
_String_
|Name of the Helm release (defaults to `context.componentId`). Change this
 value if you want to install separate instances of the Helm chart in the
 same namespace. In that case, make sure to use `{{ .Release.Name }}` in
 resource names to avoid conflicts.  Only relevant if the directory
 referenced by `chartDir` exists.


| *helmValues* +
_Map<String,&nbsp;String>_
|Key/value pairs to pass as values (by default, the key `imageTag` is set
 to the config option `imageTag`). Only relevant if the directory
 referenced by `chartDir` exists.


| *helmValuesFiles* +
_List<String>_
|List of paths to values files (empty by default). Only relevant if the
 directory referenced by `chartDir` exists.


| *imageTag* +
_String_
|Image tag on which to apply the `latest` tag (defaults to `context.shortGitCommit`).


| *openshiftDir* +
_String_
|Directory with OpenShift templates (defaults to `openshift`).


| *selector* +
_String_
|Selector scope used to determine which resources are part of a component
 (defaults to `context.selector`).


| *tailorExclude* +
_String_
|Resource kind exclusion used by Tailor (defaults to `bc,is`). Only
 relevant if the directory referenced by `openshiftDir` exists.


| *tailorParamFile* +
_String_
|Path to Tailor parameter file (defaults to none). Only relevant if the
 directory referenced by `openshiftDir` exists.


| *tailorParams* +
_List<String>_
|Additional parameters to pass to Tailor (defaults to `[]`). Only
 relevant if the directory referenced by `openshiftDir` exists.


| *tailorPreserve* +
_List<String>_
|Paths to preserve in the live configuration (defaults to `[]`). Only
 relevant if the directory referenced by `openshiftDir` exists.


| *tailorPrivateKeyCredentialsId* +
_String_
|Credentials name of the private key used by Tailor (defaults to
 `${context.cdProject}-tailor-private-key`). Only relevant if the
 directory referenced by `openshiftDir` exists.


| *tailorSelector* +
_String_
|Selector scope used by Tailor (defaults to config option `selector`).
 Only relevant if the directory referenced by `openshiftDir` exists.


| *tailorVerify* +
_boolean_
|Whether Tailor verifies the live configuration against the desired state
 after application (defaults to `false`). Only relevant if the directory
 referenced by `openshiftDir` exists.

|===

== Notable Differences between tailor and helm deployments

When tailor does the rollout, all the created or updated OpenShift resources are automatically labeled to ease their management.
This is in contrast to helm rollouts which rely on the chart providing the desired labels.
Add labels either via the chart directly or via supplying them in the values or values files.

Detailed information about the labelling can be found xref:jenkins-shared-library:labelling.adoc[here].
